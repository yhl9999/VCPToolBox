# IMAPSearch VCP Plugin

This document provides instructions for setting up and using the IMAPSearch VCP plugin.

---

## English Instructions

### 1. Overview

IMAPSearch is a synchronous VCP plugin designed to perform full-text searches on the local email archive generated by the `IMAPIndex` static plugin. It's built to work alongside `IMAPIndex`, assuming a parallel directory structure.

### 2. Setup

1.  **Place the Plugin**: Copy the entire `IMAPSearch` directory into the `Plugin` directory of your VCP host instance. The final structure should look like this:
    ```
    VCPHost/
    ├── Plugin/
    │   ├── IMAPIndex/
    │   └── IMAPSearch/  <-- Here
    └── ...
    ```

2.  **Configuration (Optional)**: Create a `config.env` file inside the `IMAPSearch` directory by copying `config.env.example`. You can override the default settings:
    ```env
    # IMAPSearch/config.env

    # Specify a different mail storage directory.
    # Default is '../IMAPIndex/mail_store'
    # MAIL_INDEX_DIR=/path/to/your/mail_store

    # Set the default number of results per page.
    # Default is 5.
    # SEARCH_RESULT_LIMIT=10
    ```

The VCP host will automatically load the plugin based on `plugin-manifest.json`.

### 3. Usage

To use the plugin, an AI agent needs to generate a `TOOL_REQUEST` block.

-   **Tool**: `IMAPSearch`
-   **Description**: Performs a case-insensitive full-text search across all locally stored emails.
-   **Parameters**:
    -   `query` (string, required): The keyword or phrase to search for. Aliases: `q`, `text`.
    -   `limit` (number, optional, default: 5): The maximum number of results to return. Alias: `size`.
    -   `nextCursor` (number, optional, default: 0): The offset for pagination, obtained from a previous search result.

#### Example VCP Call

```
<<<[TOOL_REQUEST]>>>
maid:「始」Agent「末」,
tool_name:「始」IMAPSearch「末」,
query:「始」Quarterly financial report「末」,
limit:「始」3「末」,
nextCursor:「始」0「末」
<<<[END_TOOL_REQUEST]>>>
```

#### Response Format

-   **Success**: The `result.content` array contains objects where `text` is the full Markdown content of a matched email.
    ```json
    {
      "status": "success",
      "result": {
        "content": [
          {
            "type": "text",
            "text": "---\nFrom:...\nSubject:...\n---\n\nFull email content..."
          }
        ],
        "nextCursor": 3 
      }
    }
    ```
    *If `nextCursor` is `null`, there are no more results.*

-   **Error**:
    ```json
    {
      "status": "error",
      "code": "ERROR_CODE",
      "error": "A descriptive error message."
    }
    ```

### 4. Troubleshooting

-   **No results found**:
    -   Ensure the `IMAPIndex` plugin has run successfully and populated the `mail_store` directory.
    -   Verify that the `MAIL_INDEX_DIR` path in `config.env` (if used) is correct relative to the VCP host's root.
    -   Check your search query.
-   **`FILE_SYSTEM_ERROR`**:
    -   This indicates a problem reading the mail directory. Check file permissions and ensure the directory exists.

---

## 中文说明

### 1. 概述

IMAPSearch 是一个 VCP 同步插件，用于对 `IMAPIndex` 静态插件生成的本地邮件存档执行全文搜索。它被设计为与 `IMAPIndex` 协同工作，并假定两者处于平级的目录结构中。

### 2. 设置

1.  **放置插件**: 将整个 `IMAPSearch` 文件夹复制到你的 VCP 主机实例的 `Plugin` 目录下。最终结构应如下所示：
    ```
    VCPHost/
    ├── Plugin/
    │   ├── IMAPIndex/
    │   └── IMAPSearch/  <-- 在这里
    └── ...
    ```

2.  **配置 (可选)**: 在 `IMAPSearch` 目录中，通过复制 `config.env.example` 来创建一个 `config.env` 文件。你可以覆盖默认设置：
    ```env
    # IMAPSearch/config.env

    # 指定一个不同的邮件存储目录。
    # 默认为 '../IMAPIndex/mail_store'
    # MAIL_INDEX_DIR=/path/to/your/mail_store

    # 设置每页默认返回的结果数量。
    # 默认为 5。
    # SEARCH_RESULT_LIMIT=10
    ```

VCP 主机将根据 `plugin-manifest.json` 文件自动加载此插件。

### 3. 使用方法

要使用此插件，AI 代理需要生成一个 `TOOL_REQUEST` 块。

-   **工具**: `IMAPSearch`
-   **描述**: 在所有本地存储的邮件中执行不区分大小写的全文搜索。
-   **参数**:
    -   `query` (字符串, 必需): 需要搜索的关键词或短语。别名: `q`, `text`。
    -   `limit` (数字, 可选, 默认: 5): 返回的最大结果数量。别名: `size`。
    -   `nextCursor` (数字, 可选, 默认: 0): 用于分页的偏移量，从上一次搜索结果中获取。

#### VCP 调用示例

```
<<<[TOOL_REQUEST]>>>
maid:「始」Agent「末」,
tool_name:「始」IMAPSearch「末」,
query:「始」关于第三季度的财务报告「末」,
limit:「始」3「末」,
nextCursor:「始」0「末」
<<<[END_TOOL_REQUEST]>>>
```

#### 响应格式

-   **成功**: `result.content` 数组包含多个对象，其中 `text` 字段是匹配到的邮件的完整 Markdown 内容。
    ```json
    {
      "status": "success",
      "result": {
        "content": [
          {
            "type": "text",
            "text": "---\nFrom:...\nSubject:...\n---\n\n邮件全文..."
          }
        ],
        "nextCursor": 3
      }
    }
    ```
    *如果 `nextCursor` 为 `null`，表示没有更多结果。*

-   **错误**:
    ```json
    {
      "status": "error",
      "code": "错误代码",
      "error": "详细的错误信息。"
    }
    ```

### 4. 故障排查

-   **找不到结果**:
    -   确保 `IMAPIndex` 插件已成功运行并生成了 `mail_store` 目录。
    -   如果使用了 `config.env`，请验证 `MAIL_INDEX_DIR` 路径（相对于 VCP 主机根目录）是否正确。
    -   检查你的搜索查询。
-   **`FILE_SYSTEM_ERROR`**:
    -   此错误表示读取邮件目录时出现问题。请检查文件权限并确认目录存在。